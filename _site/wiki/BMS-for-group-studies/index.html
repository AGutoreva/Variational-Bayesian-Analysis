<!DOCTYPE html>
<html>

      <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>VBA toolbox</title>
        <meta name="viewport" content="width=device-width">
        <meta name="description" content="Write an awesome description for your new site here. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />
        <link rel="canonical" href="/wiki/BMS-for-group-studies//" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">
        <!-- <link rel="stylesheet" href="/css/pygments_default.css">-->

<!-- icon font -->
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!--<script type="text/javascript" src="/js/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript" src="/js/jQuery.js"></script>
<script type="text/javascript" src="/js/toc.js"></script>-->
<script type="text/javascript">
$(document).ready(function() {
    $('.toc').toc();
});
</script>

<!--<script type="text/javascript" src="/js/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->

    </head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">VBA toolbox</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        <a class="page-link" href="/install"><i class="fa fa-download"></i> Install</a>
        <a class="page-link" href="/wiki"><i class="fa fa-book"></i> Wiki</a>
        <a class="page-link" href="/about"><i class="fa fa-mortar-board"></i> About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">
  <header class="post-header">
  <h1 id="title"><a href="/wiki">WIKI</a>&nbsp;BMS for group studies</h1>
 </header>

  <article class="post-content">
    <hr/>
  <ul id="markdown-toc">
  <li><a href="#ffx-bms">FFX-BMS</a></li>
  <li><a href="#rfx-bms">RFX-BMS</a></li>
  <li><a href="#between-conditions-rfx-bms">Between-conditions RFX-BMS</a></li>
  <li><a href="#between-groups-rfx-bms">Between-groups RFX-BMS</a></li>
</ul>

<p>Here, we address the problem of Bayesian model selection (BMS) at the group level. First of all, note that one could perform such analysis under two qualitatively distinct assumptions:</p>

<ul>
  <li><strong>fixed-effect analysis (FFX)</strong>: a single model best describes all subjects</li>
  <li><strong>random-effect analysis (RFX)</strong>: models are treated as random effects that could differ between subjects, with an unknown population distribution (described in terms of model frequencies/proportions).</li>
</ul>

<p>We first recall how to perform an FFX analysis. We then expose how to perform a RFX analysis. Finally, we address the problem of between group or condition model comparisons.  The key idea is to quantify the evidence for a difference in model labels or frequencies across groups or conditions.</p>

<h2 id="ffx-bms">FFX-BMS</h2>

<p>In brief, FFX-BMS assumes that the same model generated the data of all subjects. NB: subjects might still differ with each other through different model parameters. The corresponding FFX generative model is depicted in the following graph:
<img src="/images/wiki/bms/ffxbms1.jpg" alt="" /><br />
where <code>m</code> is the group’s label (it assigns the group to a given model) and <code>y</code> are (subject-dependent) experimentally measured datasets.</p>

<p>Under FFX assumptions, the posterior probability of a given model is expressed as:</p>

<script type="math/tex; mode=display"> p(m\mid y_1,\dots,y_n )\propto p(y_1,\dots,y_n\mid m)p(m)= p(y_1\mid m)\dots p(y_n\mid m)p(m) </script>

<p>Thus, FFX-BMS simply proceeds as a subject-level BMS, having summed the model log-evidences over subjects.</p>

<p>FFX-BMS is valid whenever one may safely assume that the group of subjects is homogeneous.</p>

<h2 id="rfx-bms">RFX-BMS</h2>

<p>In RFX-BMS, models are treated as random effects that could differ between subjects and have a fixed (unknown) distribution in the population. Critically, the relevant statistical quantity is the frequency with which any model prevails in the population. This random effects BMS procedure complements fixed effects procedures that assume subjects are sampled from a homogenous population with one (unknown) model. The corresponding RFX generative model is depicted in the following graph:</p>

<p><img src="/images/wiki/bms/rfxbms1.jpg" alt="" /></p>

<p>where <code>r</code> is the population frequency profile, <code>m</code> is the subject’s label (it assigns each subject to a given model) and <code>y</code> are (subject-dependent) experimentally measured datasets.</p>

<p>The above RFX generative model can be inverted using a VB scheme, as follows:</p>

<pre><code>[posterior,out] = VBA_groupBMC(L);
</code></pre>

<p>where the I/O arguments of <code>VBA_groupBMC</code> are summarized as follows:</p>

<ul>
  <li><code>L</code>: <code>Kxn</code> array of log-model evidences (<code>K</code> models; <code>n</code> subjects)</li>
  <li><code>posterior</code>: a structure containing the sufficient statistics (moments) of the posterior distributions over unknown model variables (i.e. subjects’ labels and model frequencies).</li>
  <li><code>out</code>: a structure containing inversion diagnostics, e.g.: RFX log-evidence, exceedance probabilities (see below), etc…</li>
</ul>

<p>In Stephan et al. (2009), we introduced the notion of exceedance probability (EP), which measures how likely it is that any given model is more frequent than all other models in the comparison set. Estimated model frequencies and EPs are the two summary statistics that typically constitute the results of RFX-BMS. They can be retrieved as follows:</p>

<pre><code class="language-matlab">f = out.Ef;
EP = out.ep;
</code></pre>

<p>The graphical output of <code>VBA_groupBMC.m</code> is appended below (with random log-evidences, with <code>K=4</code> and <code>n=16</code>):</p>

<p><img src="/images/wiki/bms/rfxbms2.jpg" alt="" /></p>

<blockquote>
  <p><strong>Upper-left panel</strong>: log-evidences (y-axis) over each model (x-axis). NB: Each line/colour identifies one subjects within the group. <strong>Middle-left panel</strong>: exceedance probabilities (y-axis) over models (x-axis). <strong>Lower-left panel</strong>: RFX free energy (y-axis) over VB iterations (x-axis). NB: the log-evidence (+/- 3) of the FFX (resp., “null”) model is shown in blue (resp. red) for comparison purposes. NB: here, the observed log-evidence are better explained by chance than by the RFX generative model (cf. simulated random log-evidences)! <strong>Upper-right panel</strong>: model attributions (subjects’ labels), in terms of the posterior probability (colour code) of each model (x-axis) to best explain each subject (y-axis). <strong>Middle-right panel</strong>: estimated model frequencies (y-axis) over models (x-axis). NB: the red line shows the “null” frequency profile over models.</p>
</blockquote>

<p>Note that optional arguments can be passed to the function, which can be used to control the convergence of the VB scheme. Importantly, information Re: <strong>model families</strong> are passed through an <code>options</code> variable (see header of <code>VBA_groupBMC.m</code>):</p>

<pre><code>options.families = {[1,2],[3,4]};
[posterior,out] = VBA_groupBMC(L,options);
</code></pre>

<p>The above script effectively forces RFX-BMS to perform family inference at the group-level, where the first (resp. second) family contains the first and second (resp., third and fourth) model. Queering the family frequencies and EPs can be done as follows:</p>

<pre><code>ff = out.families.Ef;
fep = out.families.ep;
</code></pre>

<p><img src="/images/wiki/bms/rfxbms3.jpg" alt="" /></p>

<blockquote>
  <p>(Same format as before). NB: in the lower-left panel, one can also eyeball the “family null” log-evidence (here, it is confounded with the above “model null”). <strong>Lower-right panel</strong>: model space partition and estimated frequencies (y-axis) over families (x-axis).</p>
</blockquote>

<h2 id="between-conditions-rfx-bms">Between-conditions RFX-BMS</h2>

<p>Now what if we are interested in the difference between treatment conditions; for example, when dealing with one group of subjects measured under two conditions? One could think that it would suffice to perform RFX-BMS independently for the different conditions, and then check to see whether the results of RFX-BMS were consistent. However, this approach is limited, because it does not test the hypothesis that the same model describes the two conditions. In this section, we address the issue of evaluating the evidence for a difference – in terms of models – between conditions.</p>

<p>Let us assume that the experimental design includes <code>p</code> conditions, to which a group of <code>n</code> subjects were exposed. Subject-level model inversions were performed prior to the group-level analysis, yielding the log-evidence of each model, for each subject under each condition. One can think of the conditions as inducing an augmented model space composed of model “tuples” that encode all combinations of candidate models and conditions. Here, each tuple identifies which model underlies each condition (e.g., tuple 1: model 1 in both conditions 1 and 2, tuple 2: model 1 in condition 1 and model 2 in condition 2, etc…). The log-evidence of each tuple (for each subject) can be derived by appropriately summing up the log evidences over conditions.</p>

<p>Note that the set of induced tuples can be partitioned into a first subset, in which the same model underlies all conditions, and a second subset containing the remaining tuples (with distinct condition-specific models). One can the use family RFX-BMS to ask whether the same model underlies all conditions. This is the essence of between-condition RFX-BMS, which is performed automatically as follows:</p>

<pre><code>[ep,out] = VBA_groupBMCbtw(L);
</code></pre>
<p>where the I/O arguments of <code>VBA_groupBMCbtw</code> are summarized as follows:</p>

<ul>
  <li><code>L</code>: Kxnxp array of log-model evidences (K models; n subjects; p conditions)</li>
  <li><code>ep</code>: exceedance probability of no difference in models across conditions.</li>
  <li><code>out</code>: diagnostic variables (see the header of <code>VBA_groupBMCbtw.m</code>).</li>
</ul>

<p>Now, one may be willing to ask whether the same model family underlies all conditions. For example, one may not be interested in knowing that different conditions may induce some variability in  models that do not cross the borders of some relevant model space partition. This can be done as follows:</p>

<pre><code>options.families = {[1,2],[3,4]};
[ep,out] = VBA_groupBMCbtw(L,options);
</code></pre>

<p>Here, the EP will be high if, for most subjects, either family 1 (models 1 and 2) or family 2 (models 3 and 4) are most likely, irrespective of conditions.</p>

<p>If the design is factorial (e.g., conditions vary along two distinct dimensions), one may be willing to ask whether there is a difference in models along each dimension of the factorial design. For example, let us consider a 2x2 factorial design:</p>

<pre><code>factors = [[1,2];[3,4]];
[ep,out] = VBA_groupBMCbtw(L,[],factors);
</code></pre>

<p>Here, the input argument <code>factors</code> is the (2x2) factorial condition attribution matrix, whose entries contain the index of the corresponding condition (<code>p=4</code>). The output argument <code>ep</code> is a 2x1 vector, quantifying the EP that models are identical along each dimension of the factorial design.</p>

<p>Of course, one may want to combine family inference with factorial designs, as follows:</p>

<pre><code>options.families = {[1,2],[3,4]};
factors = [[1,2];[3,4]];
[ep,out] = VBA_groupBMCbtw(L,options,factors);
</code></pre>

<p>Note that the ensuing computational cost scales linearly with the number of dimensions in the factorial design, but is an exponential function of the number of conditions (there are <code>K^p</code> tuples).</p>

<h2 id="between-groups-rfx-bms">Between-groups RFX-BMS</h2>

<p>Assessing between-group model comparison in terms of random effects amounts to asking whether model frequencies are the same or different between groups. In other words, one wants to compare the two following hypotheses (at the group level):</p>

<ul>
  <li>
    <p><script type="math/tex">H_=</script>: data <code>y</code> come from the same population, i.e. model frequencies are the same for all subgroups:
<img src="/images/wiki/bms/rfxbmsbtw0.jpg" alt="" /><br />
Under <script type="math/tex">H_=</script> , the group-specific datasets can be pooled to perform a standard RFX-BMS, yielding a single evidence <script type="math/tex">p(y|H_{=})</script>:
<code>
L = [L1,L2];
[posterior,out] = VBA_groupBMC(L);
Fe = out.F;
</code><br />
where <code>L1</code> (resp. <code>L2</code>) is the subject-level log-evidence matrix of the first -resp. second) group of subjects, and <code>Fe</code> is the log-evidence of the group-hypothesis <script type="math/tex">H_=</script>.</p>
  </li>
  <li>
    <p><script type="math/tex">H_{\neq}</script>: subjects’ data <code>y</code> come from different populations, i.e. they have distinct model frequencies:
<img src="/images/wiki/bms/rfxbmsbtw2.jpg" alt="" /><br />
Under <script type="math/tex">H_{\neq}</script>, datasets are marginally independent. In this case, the evidence <script type="math/tex">p(y|H_{\neq})</script> is the product of group-specific evidences:
<code>
[posterior1,out1] = VBA_groupBMC(L1);
[posterior2,out2] = VBA_groupBMC(L2);
Fd = out1.F + out2.F;
</code><br />
where <code>Fe</code> is the log-evidence of the group-hypothesis <script type="math/tex">H_{\neq}</script>.</p>
  </li>
</ul>

<p>The posterior probability <script type="math/tex">P</script> that the two groups have distinct model frequencies is thus simply given by:</p>

<script type="math/tex; mode=display">P=\frac{1}{1+e^{Fe-Fd}}</script>

<p>This completes our introduction to RFX-BMS.</p>

 <hr/>
  <div class='return_link'><a href="#title"><i class="fa fa-chevron-up"></i> back to top</a></div>
  </article>


</div>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">


    <div class="footer-col-1 column">
        <h2 class="footer-heading">Participate to the VBA-toolbox!</h2>

          <ul>
        <li>
           <i class="fa fa-github-square fa-fw "></i>
          <a href="https://github.com/MBB-team/VBA-toolbox/fork">fork on Github</a>
        </li>
        <li>
          <i class="fa fa-edit fa-fw "></i>
          <a href="https://github.com/MBB-team/VBA-toolbox/issues">post a request</a>
        </li>
        </ul>

    </div>

    <div class="footer-col-2 column">
     <ul>
        <li>Jean DAUNIZEAU</li>
        <li><a href="mailto:jean.daunizeau@gmail.com">jean.daunizeau[at]gmail.com</a></li>
      </ul>
      <ul>
        <li>Lionel RIGOUX</li>
        <li><a href="mailto:lionel.rigoux@gmail.com">lionel.rigoux[at]gmail.com</a></li>
      </ul>

     </div>

    <div class="footer-col-3 column">
<p>J. Daunizeau, V. Adam, L. Rigoux (2014), VBA: a probabilistic treatment of nonlinear models for neurobiological and behavioural data. PLoS Comp Biol 10(1): e1003441.</p>
    </div>

  </div>

</footer>


    </body>

</html>
